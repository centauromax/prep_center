server {
    listen 8080;
    server_name localhost;
    
    # Comprimi le risposte
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # Servi file statici dalla cartella build
    location / {
        root /app/build;
        try_files $uri $uri/ /index.html;
    }
    
    # Gestisci le rotte di picture_check con l'app React
    location ~ ^/(picture_check|en/picture_check|it/picture_check)/ {
        root /app/build;
        try_files $uri $uri/ /index.html;
    }
    
    # Gestisci le richieste per fbasaving facendo proxy al backend Django
    location ~ ^/(fbasaving|en/fbasaving|it/fbasaving)/ {
        # Proxy pass al vero backend Django
        proxy_pass https://prepcenter-production.up.railway.app;
        
        # Imposta gli header del proxy
        proxy_set_header Host prepcenter-production.up.railway.app;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Gestione timeout e errori
        proxy_connect_timeout 5;
        proxy_send_timeout 10;
        proxy_read_timeout 10;
        
        # Gestisci errori di connessione al backend
        proxy_intercept_errors on;
        error_page 502 503 504 = @fbasaving_fallback;
    }
    
    # Fallback per fbasaving in caso di errore del backend
    location @fbasaving_fallback {
        add_header Content-Type "text/html; charset=utf-8";
        return 503 '
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>FBA Saving - Temporaneamente non disponibile</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
                .container { max-width: 800px; margin: 50px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                h1 { color: #2c3e50; }
                .warning { color: #e74c3c; font-size: 18px; margin-bottom: 20px; }
                .btn { display: inline-block; padding: 10px 20px; background-color: #3498db; color: white; text-decoration: none; border-radius: 4px; margin-top: 20px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>FBA Saving</h1>
                <p class="warning">Il servizio FBA Saving è temporaneamente non disponibile.</p>
                <p>Non è stato possibile raggiungere il backend. I nostri tecnici sono stati informati del problema.</p>
                <p>Si prega di riprovare più tardi.</p>
                <a href="/picture_check/" class="btn">Vai a Picture Check</a>
            </div>
        </body>
        </html>';
    }
} 