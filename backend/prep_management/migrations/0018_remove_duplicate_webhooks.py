# Generated by Django 4.2.13 on 2025-06-13 17:37

from django.db import migrations

def remove_duplicate_webhooks(apps, schema_editor):
    """
    Rimuove i duplicati dalla tabella ShipmentStatusUpdate usando SQL raw.
    Per ogni combinazione di shipment_id, event_type, new_status, merchant_id,
    mantiene solo il record più recente.
    """
    db_alias = schema_editor.connection.alias
    
    # SQL per rimuovere i duplicati mantenendo solo il record più recente
    sql = """
    DELETE FROM prep_management_shipmentstatusupdate a
    USING (
        SELECT shipment_id, event_type, new_status, merchant_id, MAX(created_at) as max_created_at
        FROM prep_management_shipmentstatusupdate
        GROUP BY shipment_id, event_type, new_status, merchant_id
    ) b
    WHERE a.shipment_id = b.shipment_id
    AND a.event_type = b.event_type
    AND a.new_status = b.new_status
    AND a.merchant_id = b.merchant_id
    AND a.created_at < b.max_created_at;
    """
    
    # Esegui la query
    schema_editor.execute(sql)

class Migration(migrations.Migration):

    dependencies = [
        ('prep_management', '0017_handle_duplicate_webhooks'),
    ]

    operations = [
        migrations.RunPython(remove_duplicate_webhooks),
    ]
