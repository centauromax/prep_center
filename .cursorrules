# Prep Center - FBA Prep Center Italy

## âš ï¸ **REGOLE CRITICHE PER LO SVILUPPO**

### ðŸš¨ **REGOLA PRINCIPALE: NON TOCCARE CIÃ’ CHE FUNZIONA**
**MAI modificare, cambiare o riscrivere funzioni, servizi o logiche che funzionano correttamente.**
- Se il sistema riceve notifiche Telegram âœ… â†’ NON toccare il sistema di notifiche
- Se i webhook funzionano âœ… â†’ NON toccare la logica dei webhook  
- Se le API calls funzionano âœ… â†’ NON toccare i client API
- **SOLO aggiungere nuovo codice o correggere errori specifici**
- **MAI riscrivere intere funzioni "per migliorarle"**
- **Preferire sempre edit mirati invece di rewrite completi**

### ðŸ“‹ **ACCESSO AI LOG DI PRODUZIONE (Railway)**
Per visualizzare i log di produzione su Railway:

```bash
# COMANDO CORRETTO per vedere i log del backend
gtimeout 60 railway logs -s prep_center_backend

# Alternativa con timeout diverso
gtimeout 120 railway logs -s prep_center_backend

# Per altri servizi specifici se necessario
gtimeout 60 railway logs -s [nome_servizio]
```

**NOTA**: Usare sempre `gtimeout` invece di `railway logs` diretto per evitare timeout.
### ðŸš€ **MONITORAGGIO DEPLOYMENT INTELLIGENTE**

**âŒ MAI usare tempi di attesa fissi** come `sleep 30` per aspettare il deployment.
**âœ… SEMPRE usare lo script di monitoraggio intelligente** che verifica attivamente lo stato.

#### **Script di Monitoraggio Deployment**
```bash
# âœ… COMANDO CORRETTO - Monitoraggio intelligente
./scripts/wait_for_deployment.sh

# âŒ MAI FARE - Attesa fissa
sleep 30 && railway logs

# âŒ MAI FARE - Attesa arbitraria
sleep 60 && curl https://backend.fbaprepcenteritaly.com/
```

#### **FunzionalitÃ  dello Script Intelligente**
- **âœ… Verifica commit hash**: Controlla che il deployment corrisponda al commit locale
- **âœ… Health check**: Testa che il backend risponda correttamente
- **âœ… Test endpoint**: Verifica endpoint specifici come `/prep_management/api-debug/`
- **âœ… Timeout intelligente**: Massimo 5 minuti con controlli ogni 10 secondi
- **âœ… Logging colorato**: Output chiaro con stati di progresso
- **âœ… Exit codes**: Ritorna 0 per successo, 1 per errore

#### **Workflow Corretto Post-Commit**
```bash
# 1. Commit e push
git add -A && git commit -m "Fix description" && git push origin main

# 2. Monitoraggio intelligente (NON attesa fissa)
./scripts/wait_for_deployment.sh

# 3. Se successo, procedi con verifiche
if [ $? -eq 0 ]; then
    echo "âœ… Deployment completato, sistema operativo"
    # Eventuali test aggiuntivi...
else
    echo "âŒ Deployment fallito o timeout"
    # Gestione errori...
fi
```

#### **Vantaggi del Monitoraggio Intelligente**
- **âš¡ PiÃ¹ veloce**: Non aspetta tempo inutile se il deployment Ã¨ giÃ  pronto
- **ðŸ” PiÃ¹ preciso**: Verifica effettivamente che il sistema funzioni
- **ðŸ“Š PiÃ¹ informativo**: Mostra lo stato di progresso in tempo reale
- **ðŸ›¡ï¸ PiÃ¹ sicuro**: Rileva problemi di deployment prima di procedere
- **ðŸŽ¯ PiÃ¹ affidabile**: Non dipende da tempi fissi che possono variare

#### **Personalizzazione Script**
Lo script puÃ² essere personalizzato modificando:
- `MAX_ATTEMPTS=30` - Numero massimo di tentativi
- `SLEEP_INTERVAL=10` - Intervallo tra controlli (secondi)
- `BACKEND_URL` - URL del backend da testare
- Endpoint specifici da testare nel test finale

**REGOLA**: Ogni volta che devi aspettare un deployment, usa SEMPRE `./scripts/wait_for_deployment.sh`


## ðŸŽ¯ Panoramica del Progetto

**Prep Center** Ã¨ una piattaforma completa per la gestione di servizi di preparazione FBA (Fulfillment by Amazon) sviluppata per FBA Prep Center Italy. 

### ðŸš€ **AMBIENTE DI PRODUZIONE: Railway.app**
L'applicazione Ã¨ **DEPLOYATA E ATTIVA** su Railway.app con i seguenti domini:
- **Backend Principale**: `backend.fbaprepcenteritaly.com` - **DOMINIO UNIFICATO PRINCIPALE**
- **Frontend Picture Check**: `apppc.fbaprepcenteritaly.com` - **Separato perchÃ© Ã¨ implementato in React con servizio Railway separato**
- **Railway URL**: `prepcenter-production.up.railway.app`

### ðŸ—ï¸ Il sistema comprende:

- **Backend Django** con API REST per la gestione completa dei servizi
- **Frontend React** per la verifica delle foto dei prodotti
- **Bot Telegram multilingua** per notifiche e comunicazioni
- **Sistema di processamento file** per gestione documenti e backup
- **Gestione pallet** con etichettatura PDF e tracking
- **Dashboard unificata** per accesso centralizzato a tutte le app
- **ðŸ†• Sistema Shared Library** per API calls centralizzate
- **ðŸ†• Integrazione Prep Business API** per gestione merchants e shipments
- **ðŸ†• Sistema Webhook** per notifiche real-time da Prep Business

## ðŸ—ï¸ Architettura del Sistema

### Backend (Django 4.2.13)
**Posizione**: `/backend/`
**Entry Point**: `manage.py` (in `/backend/manage.py` non nella root)
**Settings**: `prep_center.settings`

#### Applicazioni Django
1. **prep_management** - Core del sistema, gestione preparazione ordini + **ðŸ†• Webhook system**
2. **picture_check** - Verifica foto prodotti
3. **return_management** - Gestione resi
4. **fbasaving** - Gestione file e backup
5. **pallet_label** - Etichettatura pallet con generazione PDF

#### ðŸ†• **Sistema Shared Library**
**Posizione**: `/backend/libs/`
- **Configurazione centralizzata**: Gestione API keys e configurazioni
- **Client API riutilizzabili**: Per integrazioni esterne
- **Utilities condivise**: Funzioni comuni tra app
- **Gestione errori**: Error handling standardizzato

#### Dipendenze Principali
```
Django==4.2.13
djangorestframework==3.15.1
django-cors-headers==4.4.0
celery==5.4.0
redis==5.0.4
gunicorn==22.0.0
whitenoise==6.7.0
psycopg2-binary==2.9.9
requests-toolbelt==1.0.0
pandas==2.2.2
pytz==2024.1
reportlab==4.2.2
Pillow==10.3.0
python-dotenv==1.0.1  # ðŸ†• Per gestione environment variables
requests==2.32.3      # ðŸ†• Per API calls
```

### Frontend (React 18.2.0)
**Posizione**: `/frontend_picture_check/`
**Scopo**: App React per verifica foto prodotti
**Build**: I file compilati vengono integrati nel backend Django

#### Caratteristiche
- Selettore clienti
- Input per verifica EAN
- Visualizzazione esito verifica
- Cronologia EAN verificati
- Gestione suoni per feedback utente

### Database
- **ðŸš€ PRODUZIONE (Railway)**: PostgreSQL (Database principale)
- **ðŸ’» Sviluppo locale**: SQLite (`db.sqlite3`) - Solo per testing
- **ORM**: Django ORM
- **Migrazioni**: Gestite tramite Django migrations

## ðŸš€ **DEPLOYMENT ATTIVO SU RAILWAY**

### ðŸŒ **Ambiente di Produzione (ATTIVO)**
- **Platform**: Railway.app - **AMBIENTE PRINCIPALE**
- **Status**: âœ… **DEPLOYATO E ATTIVO**
- **Database**: PostgreSQL (gestito da Railway)
- **Static Files**: Serviti da WhiteNoise
- **Background Tasks**: Celery con Redis

### Railway Configuration
- **Procfile**: Definisce 3 servizi in produzione
  - `release`: Deploy script e migrazioni
  - `web`: Server web Gunicorn (ATTIVO)
  - `worker`: Worker Celery per task asincroni (ATTIVO)
- **ðŸŒ Domains ATTIVI**: 
  - `backend.fbaprepcenteritaly.com` - **DOMINIO PRINCIPALE UNIFICATO**
  - `apppc.fbaprepcenteritaly.com` - **CompatibilitÃ  Picture Check**  
  - `prepcenter-production.up.railway.app` - **Railway URL**

### Environment Variables (Railway - PRODUZIONE)
```
DEBUG=False (âœ… ATTIVO in produzione)
DATABASE_URL=postgresql://... (âœ… Railway PostgreSQL)
REACT_DOMAIN=apppc.fbaprepcenteritaly.com
RAILWAY_STATIC_URL=backend.fbaprepcenteritaly.com
TELEGRAM_BOT_TOKEN=... (âœ… Bot Telegram ATTIVO)
PREP_BUSINESS_API_URL=https://dashboard.fbaprepcenteritaly.com/api  # ðŸ†• API Prep Business
PREP_BUSINESS_API_KEY=...  # ðŸ†• API Key Prep Business
PREP_BUSINESS_WEBHOOK_SECRET=...  # ðŸ†• Webhook signature verification
```

### âš ï¸ Configurazione Static Files Critica (Railway)
**IMPORTANTE**: Su Railway (PRODUZIONE), i file statici vengono raccolti in `/backend/static/`, NON in `/backend/staticfiles/`

#### Configurazione Corretta in settings.py:
```python
STATIC_ROOT = BASE_DIR / 'static'  # NON 'staticfiles'
STATICFILES_DIRS = []  # Deve essere vuoto per produzione
```

#### NON aggiungere URL patterns manuali per static files:
WhiteNoise gestisce automaticamente il serving dei file statici. Non aggiungere mai:
```python
# âŒ NON FARE QUESTO
urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
```

## ðŸ  **DASHBOARD UNIFICATA**

### Accesso Centralizzato
- **URL Principale**: `https://backend.fbaprepcenteritaly.com/` - **Dashboard homepage**
- **Navigazione**: Bootstrap responsive con card per ogni app
- **Apps Integrate**:
  - Picture Check: `/picture_check/`
  - Prep Management: `/prep_management/`
  - FBA Saving: `/fbasaving/`
  - Pallet Label: `/pallet_label/`
  - Return Management: `/return_management/`

### Configurazione Domini
- **backend.fbaprepcenteritaly.com**: Serve TUTTE le app (funzionante)
- **apppc.fbaprepcenteritaly.com**: Solo Picture Check (mantenuto per compatibilitÃ )

## ðŸ†• **SISTEMA SHARED LIBRARY**

### Struttura Libs
```
backend/libs/
â”œâ”€â”€ __init__.py                    # Package initialization
â”œâ”€â”€ config.py                      # Configurazione centralizzata
â”œâ”€â”€ api_client/                    # Client API esterni
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ prep_business.py          # Client Prep Business API
â””â”€â”€ utils/                         # Utilities condivise
    â””â”€â”€ __init__.py
```

### Configurazione API (libs/config.py)
- **Environment Variables**: Gestione centralizzata con python-dotenv
- **API URLs**: Configurazione endpoint esterni
- **Secrets Management**: API keys e tokens sicuri
- **Fallback Values**: Valori di default per sviluppo

## ðŸš¨ **CLIENT PREP BUSINESS API - REGOLE CRITICHE**

### âš ï¸ **REGOLA FONDAMENTALE: UN SOLO CLIENT**
**ESISTE UN SOLO CLIENT UFFICIALE PER PREP BUSINESS API:**
- **File**: `libs/prepbusiness/client.py` - **QUESTO Ãˆ L'UNICO CLIENT DA USARE**
- **âŒ MAI creare altri client** - Usare sempre questo
- **âŒ MAI duplicare logiche API** - Tutto deve passare da qui
- **âŒ MAI importare direttamente** `libs/prepbusiness/client.py` - Ãˆ interno

### ðŸ—ï¸ **ARCHITETTURA CLIENT (POST-ELIMINAZIONE WRAPPER 2024-01-13)**

#### **Client Ufficiale PrepBusiness**
**File**: `libs/prepbusiness/client.py` (âœ… UNICO CLIENT UFFICIALE)
- **Client completo** che usa internamente il client completo
- **Interfaccia semplificata** per mantenere compatibilitÃ 
- **Tutti i metodi necessari** per l'inbound residuale
- **Error handling** standardizzato
- **Logging** dettagliato

#### **Client PrepBusiness Ufficiale** 
**File**: `libs/prepbusiness/client.py` (âš ï¸ UNICO CLIENT UFFICIALE)
- **2177 righe** di codice completo con Pydantic models
- **Usato internamente** dal wrapper
- **âŒ NON importare direttamente** - Usare sempre il client ufficiale

### ðŸ“‹ **COME USARE IL CLIENT (ESEMPI PRATICI)**

#### **âœ… MODO CORRETTO - Usare sempre il client ufficiale:**
```python
# âœ… SEMPRE COSÃŒ
from libs.prepbusiness.client import PrepBusinessClient

# Inizializzazione
client = PrepBusinessClient()

# Merchants
merchants = client.get_merchants()                    # Lista merchants (tutti, non solo attivi)
merchant = client.get_merchant(merchant_id)          # Dettaglio merchant

# Shipments  
shipments = client.get_shipments(merchant_id=None)   # Lista shipments
shipment = client.get_shipment(shipment_id)          # Dettaglio shipment
new_shipment = client.create_shipment(data)          # Crea shipment
updated = client.update_shipment(shipment_id, data)  # Aggiorna shipment

# ðŸ†• METODI AGGIUNTI DOPO MIGRAZIONE (per inbound residuale)
client.add_item_to_shipment(shipment_id, item_data)  # âœ… DISPONIBILE!
client.create_inbound_shipment(data)                 # âœ… DISPONIBILE!
# ... tutti gli altri metodi del client completo
```

#### **âŒ MODI SBAGLIATI - NON FARE MAI:**
```python
# âŒ NON FARE - Creare wrapper alternativi
from libs.api_client.prep_business import PrepBusinessClient  # FILE ELIMINATO!

# âŒ NON FARE - Creare client custom
class MyPrepBusinessClient:  # SBAGLIATO!
    pass

# âŒ NON FARE - Duplicare logiche API
def my_get_merchants():  # SBAGLIATO!
    # logica duplicata...
```

### ðŸ”§ **CONFIGURAZIONE E INIZIALIZZAZIONE**

#### **Configurazione Automatica**
Il client si configura automaticamente usando:
1. **Environment Variables** (Railway/produzione)
2. **Database Config** (PrepBusinessConfig model)
3. **Fallback values** (sviluppo locale)

#### **Parametri di Configurazione**
```python
# Configurazione automatica da environment/database
PREP_BUSINESS_API_URL = "https://dashboard.fbaprepcenteritaly.com/api"
PREP_BUSINESS_API_KEY = "jtc_..."  # Da environment variables
PREP_BUSINESS_API_TIMEOUT = 30     # Timeout in secondi
PREP_BUSINESS_MAX_RETRIES = 3      # Retry automatici
```

### ðŸ†• **METODI COMPLETI DISPONIBILI (POST-MIGRAZIONE)**

#### **Merchants Management**
```python
client.get_merchants()                    # Lista tutti merchants (enabled=False di default)
client.get_merchant(merchant_id)          # Dettaglio merchant specifico
```

#### **Shipments Management** 
```python
client.get_shipments(merchant_id=None)    # Lista shipments (tutti o per merchant)
client.get_shipment(shipment_id)          # Dettaglio shipment
client.create_shipment(data)              # Crea nuovo shipment
client.update_shipment(shipment_id, data) # Aggiorna shipment esistente
client.create_inbound_shipment(data)      # ðŸ†• Crea inbound shipment
```

#### **Items Management (ðŸ†• AGGIUNTI DOPO MIGRAZIONE)**
```python
client.add_item_to_shipment(shipment_id, item_data)     # âœ… Aggiunge item a shipment
client.get_shipment_items(shipment_id)                  # âœ… Lista items di shipment
client.update_shipment_item(item_id, data)              # âœ… Aggiorna item
client.remove_item_from_shipment(shipment_id, item_id)  # âœ… Rimuove item
```

#### **Altri Metodi Disponibili**
```python
# Tutti i metodi sono disponibili direttamente nel client ufficiale
# Vedere libs/prepbusiness/client.py per lista completa (2177 righe)
```

### ðŸš¨ **PROBLEMI RISOLTI NELLA MIGRAZIONE**

#### **Problema 1: Metodo Mancante**
- **âŒ PRIMA**: `add_item_to_shipment()` non esisteva nel client semplice
- **âœ… DOPO**: Tutti i metodi del client completo disponibili nel client ufficiale

#### **Problema 2: Filtro Merchants Errato**
- **âŒ PRIMA**: Filtrava per `active_only=True` con campo `active` 
- **âœ… DOPO**: Usa `active_only=False` di default con campo `enabled`

#### **Problema 3: Struttura Risposta API**
- **âŒ PRIMA**: Si aspettava lista diretta, ma API restituisce `{data: [...]}`
- **âœ… DOPO**: Client restituisce direttamente `response.data`

### Database Configuration (PrepBusinessConfig)
- **Modello Django**: Configurazione API salvata in database
- **Admin Interface**: Gestione configurazioni via Django admin
- **Override Environment**: Configurazioni database sovrascrivono environment
- **Validazione**: Validazione URL e API key

## ðŸ†• **SISTEMA WEBHOOK PREP BUSINESS**

### Modello ShipmentStatusUpdate
**Posizione**: `prep_management/models.py`

#### Campi Principali
```python
event_type = models.CharField(max_length=50)      # Tipo evento (inbound_shipment.created, etc.)
entity_type = models.CharField(max_length=50)     # Tipo entitÃ  (shipment, order, invoice)
entity_id = models.CharField(max_length=100)      # ID entitÃ 
merchant_id = models.CharField(max_length=100)    # ID merchant
status = models.CharField(max_length=50)          # Stato shipment
notes = models.TextField(blank=True)              # Note aggiuntive
payload = models.JSONField()                      # Payload completo webhook
processed = models.BooleanField(default=False)    # Flag elaborazione
signature_verified = models.BooleanField()       # Verifica firma webhook
created_at = models.DateTimeField(auto_now_add=True)
```

### Endpoint Webhook
- **URL**: `/prep_management/webhook/shipment-status/`
- **Metodo**: POST
- **Content-Type**: `application/json`
- **Signature Verification**: Opzionale con HMAC-SHA256
- **Response**: JSON con status e message

### Eventi Supportati
```python
EVENT_TYPES = [
    # Inbound Shipments
    ('inbound_shipment.created', 'Inbound Shipment Created'),
    ('inbound_shipment.shipped', 'Inbound Shipment Shipped'),
    ('inbound_shipment.received', 'Inbound Shipment Received'),
    ('inbound_shipment.notes_updated', 'Inbound Shipment Notes Updated'),
    
    # Outbound Shipments
    ('outbound_shipment.created', 'Outbound Shipment Created'),
    ('outbound_shipment.shipped', 'Outbound Shipment Shipped'),
    ('outbound_shipment.notes_updated', 'Outbound Shipment Notes Updated'),
    ('outbound_shipment.closed', 'Outbound Shipment Closed'),
    
    # Orders
    ('order.created', 'Order Created'),
    ('order.shipped', 'Order Shipped'),
    
    # Invoices
    ('invoice.created', 'Invoice Created'),
]
```

### Dashboard Webhook
- **URL**: `/prep_management/shipment-updates/`
- **FunzionalitÃ **:
  - **Statistiche**: Conteggio eventi per tipo
  - **Filtri**: Per event_type, status, processed
  - **Lista**: Tabella paginata con dettagli
  - **Raw Payloads**: Visualizzazione JSON con copy-to-clipboard
  - **Badge System**: Colori per diversi tipi di evento

## ðŸ·ï¸ **APP: Pallet Label**

### FunzionalitÃ  Complete
- **Modello PalletLabel**: Gestione completa dati etichetta
  - Informazioni mittente/destinatario
  - Dettagli Amazon warehouse
  - Dimensioni e peso pallet
  - Generazione PDF automatica
- **Form Multipli**:
  - `PalletLabelForm`: Form completo con tutti i campi
  - `QuickPalletForm`: Form rapido per creazione veloce
- **Views CRUD Complete**:
  - Lista paginata con ricerca
  - Creazione con validazione
  - Modifica e dettaglio
  - Download PDF generato
- **Generazione PDF**: Usando ReportLab con layout professionale
- **Templates Bootstrap**: Responsive e moderni
- **Admin Integration**: Configurazione Django admin

### Struttura Pallet Label
```
backend/pallet_label/
â”œâ”€â”€ models.py          # Modello PalletLabel
â”œâ”€â”€ forms.py           # PalletLabelForm + QuickPalletForm
â”œâ”€â”€ views.py           # CRUD views complete
â”œâ”€â”€ urls.py            # URL routing
â”œâ”€â”€ admin.py           # Django admin config
â”œâ”€â”€ services.py        # PDF generation service
â”œâ”€â”€ templates/pallet_label/
â”‚   â”œâ”€â”€ list.html      # Lista paginata
â”‚   â”œâ”€â”€ create.html    # Form creazione
â”‚   â”œâ”€â”€ edit.html      # Form modifica
â”‚   â””â”€â”€ detail.html    # Dettaglio + download PDF
â””â”€â”€ migrations/        # Database migrations
```

## ðŸ¤– Bot Telegram Multilingua

### FunzionalitÃ 
- **Lingue supportate**: Italiano, Inglese
- **Comandi disponibili**:
  - `/start` - Messaggio benvenuto bilingue
  - `/help` - Aiuto nella lingua utente
  - `/test` - Test connessione
  - `/status` - Stato registrazione utente
  - `/language` - Cambia lingua

### Caratteristiche Tecniche
- **Traduzioni**: Sistema centralizzato in `translations.py`
- **Persistenza**: Lingua salvata nel database
- **Registrazione**: Via email con validazione
- **Notifiche**: Automatiche in lingua preferita
- **Timezone**: Configurato per `Europe/Rome`

### âš ï¸ Bug Critici Risolti nelle Notifiche

#### 1. Campo Email Errato
```python
# âŒ ERRORE - API non contiene 'email'
merchant_email = merchant_data.get('email')

# âœ… CORRETTO - API usa 'primaryEmail'
merchant_email = merchant_data.get('primaryEmail')
```

#### 2. Eventi Mancanti
Gli eventi `'inbound_shipment.created'` non erano inclusi nella lista notify_events

#### 3. Timezone Incorretto
```python
# âŒ ERRORE - Mostra orario UTC
created_at = shipment.get('createdAt')

# âœ… CORRETTO - Converte a Europe/Rome
rome_tz = pytz.timezone('Europe/Rome')
created_at_utc = datetime.fromisoformat(created_at.replace('Z', '+00:00'))
created_at_rome = created_at_utc.astimezone(rome_tz)
```

## ðŸ“ Struttura Dettagliata

```
prep_center/
â”œâ”€â”€ backend/                    # Backend Django
â”‚   â”œâ”€â”€ prep_center/           # Settings e configurazione principale
â”‚   â”‚   â”œâ”€â”€ settings.py        # Configurazione Django + libs path
â”‚   â”‚   â”œâ”€â”€ urls.py            # URL routing principale + homepage
â”‚   â”‚   â”œâ”€â”€ celery.py          # Configurazione Celery
â”‚   â”‚   â”œâ”€â”€ views.py           # Homepage dashboard view
â”‚   â”‚   â””â”€â”€ wsgi.py            # WSGI per produzione
â”‚   â”œâ”€â”€ libs/                  # ðŸ†• Sistema Shared Library
â”‚   â”‚   â”œâ”€â”€ __init__.py        # Package initialization
â”‚   â”‚   â”œâ”€â”€ config.py          # Configurazione centralizzata
â”‚   â”‚   â”œâ”€â”€ api_client/        # Client API esterni
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ prep_business.py  # Client Prep Business API
â”‚   â”‚   â””â”€â”€ utils/             # Utilities condivise
â”‚   â”‚       â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ prep_management/       # App principale gestione prep
â”‚   â”‚   â”œâ”€â”€ models.py          # Modelli database + ShipmentStatusUpdate
â”‚   â”‚   â”œâ”€â”€ views.py           # API views + webhook + debug endpoints
â”‚   â”‚   â”œâ”€â”€ services.py        # Logica business
â”‚   â”‚   â”œâ”€â”€ tasks.py           # Task Celery
â”‚   â”‚   â”œâ”€â”€ chat_manager.py    # Gestione bot Telegram
â”‚   â”‚   â”œâ”€â”€ translations.py    # Sistema traduzioni
â”‚   â”‚   â”œâ”€â”€ event_handlers.py  # Gestione eventi e notifiche
â”‚   â”‚   â”œâ”€â”€ admin.py           # Admin config + PrepBusinessConfig
â”‚   â”‚   â”œâ”€â”€ templatetags/      # ðŸ†• Template tags personalizzati
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ prep_management_extras.py  # Custom filters
â”‚   â”‚   â””â”€â”€ templates/prep_management/  # ðŸ†• Templates webhook
â”‚   â”‚       â”œâ”€â”€ merchants_list.html     # Lista merchants
â”‚   â”‚       â”œâ”€â”€ api_config_debug.html   # Debug API config
â”‚   â”‚       â””â”€â”€ shipment_status_updates.html  # Dashboard webhook
â”‚   â”œâ”€â”€ picture_check/         # App verifica foto
â”‚   â”œâ”€â”€ return_management/     # App gestione resi
â”‚   â”œâ”€â”€ fbasaving/            # App gestione file
â”‚   â”œâ”€â”€ pallet_label/         # App etichettatura pallet
â”‚   â”‚   â”œâ”€â”€ models.py          # Modello PalletLabel
â”‚   â”‚   â”œâ”€â”€ forms.py           # Form multipli
â”‚   â”‚   â”œâ”€â”€ views.py           # CRUD views
â”‚   â”‚   â”œâ”€â”€ services.py        # PDF generation
â”‚   â”‚   â”œâ”€â”€ urls.py            # URL routing
â”‚   â”‚   â”œâ”€â”€ admin.py           # Admin config
â”‚   â”‚   â””â”€â”€ templates/         # Templates Bootstrap
â”‚   â”œâ”€â”€ templates/            # Template Django + homepage
â”‚   â”‚   â”œâ”€â”€ base.html          # Template base con nav
â”‚   â”‚   â””â”€â”€ homepage.html      # Dashboard unificata
â”‚   â”œâ”€â”€ static/               # File statici (raccolti qui su Railway)
â”‚   â”œâ”€â”€ media/                # File media upload + PDF generati
â”‚   â”œâ”€â”€ manage.py             # Django management
â”‚   â””â”€â”€ requirements.txt      # Dipendenze Python aggiornate
â”œâ”€â”€ frontend_picture_check/    # Frontend React
â”‚   â”œâ”€â”€ src/                  # Codice sorgente React
â”‚   â”œâ”€â”€ public/               # File pubblici
â”‚   â”œâ”€â”€ package.json          # Dipendenze Node.js
â”‚   â””â”€â”€ postbuild.js          # Script post-build
â”œâ”€â”€ Procfile                  # Configurazione Railway
â”œâ”€â”€ railway.toml             # Configurazione Railway aggiornata
â””â”€â”€ gunicorn.conf.py         # Configurazione Gunicorn
```

## ðŸ”§ Comandi di Sviluppo

### Backend
```bash
cd backend
python manage.py runserver 0.0.0.0:8000
python manage.py migrate
python manage.py collectstatic
python manage.py shell
```

### Frontend
```bash
cd frontend_picture_check  
npm install
npm start                 # Sviluppo
npm run build            # Produzione
```

### Celery
```bash
cd backend
celery -A prep_center worker -l info
```

### ðŸ” Debug e Troubleshooting

#### ðŸš€ **Comandi Produzione (Railway)**
```bash
# Dashboard unificata (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/

# Debug endpoint notifiche Telegram (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/prep_management/telegram/debug/

# ðŸ†• Debug API Prep Business (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/prep_management/api-debug/

# ðŸ†• Lista Merchants Prep Business (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/prep_management/merchants/

# ðŸ†• Dashboard Webhook (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/prep_management/shipment-updates/

# ðŸ†• Test Webhook Endpoint (PRODUZIONE)
curl -X POST https://backend.fbaprepcenteritaly.com/prep_management/webhook/shipment-status/ \
  -H "Content-Type: application/json" \
  -d '{"event_type": "inbound_shipment.created", "data": {...}}'

# Accesso Django Admin (PRODUZIONE)
open https://backend.fbaprepcenteritaly.com/admin/

# Test API endpoints (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/api/

# Test Pallet Label app (PRODUZIONE)
curl https://backend.fbaprepcenteritaly.com/pallet_label/
```

#### ðŸ’» **Comandi Sviluppo Locale**
```bash
# Verifica file statici (locale)
python manage.py collectstatic --dry-run

# Test connessione database (locale)
python manage.py dbshell

# Test migrazioni prep_management (locale)
python manage.py showmigrations prep_management

# ðŸ†• Test API Prep Business (locale)
python manage.py shell
>>> from libs.prepbusiness.client import PrepBusinessClient
>>> client = PrepBusinessClient()
>>> merchants = client.get_merchants()

# ðŸ†• Test configurazione API (locale)
python manage.py shell
>>> from libs.config import get_prep_business_config
>>> config = get_prep_business_config()
```

## ðŸŽ¨ Tecnologie e Pattern

### Backend Pattern
- **REST API**: Usando Django REST Framework
- **Task Queue**: Celery con Redis
- **File Storage**: WhiteNoise per file statici
- **Database**: PostgreSQL in produzione, SQLite in sviluppo
- **Middleware**: CORS, Security, WhiteNoise
- **PDF Generation**: ReportLab per etichette pallet
- **ðŸ†• Shared Libraries**: Pattern per codice riutilizzabile
- **ðŸ†• API Client Pattern**: Client HTTP standardizzati
- **ðŸ†• Webhook Pattern**: Gestione eventi real-time

### Frontend Pattern
- **SPA**: Single Page Application React
- **API Integration**: Fetch API per chiamate backend
- **Build Integration**: Compilazione integrata con Django
- **Routing**: React Router DOM
- **Dashboard**: Bootstrap responsive per navigazione unificata

### Sicurezza
- **CSRF Protection**: Token CSRF per form
- **CORS**: Configurato per domini specifici
- **Environment**: Variabili ambiente per secrets
- **Allowed Hosts**: Lista domini autorizzati
- **Authentication**: Login required per app sensibili
- **ðŸ†• Webhook Signatures**: Verifica HMAC-SHA256 per webhook

## ðŸ“Š FunzionalitÃ  Principali

### Gestione Preparazione (prep_management)
- Gestione ordini e preparazione FBA
- Chat manager per comunicazioni
- Sistema di notifiche multilingue
- Task asincroni per elaborazioni lunghe
- Gestione eventi e webhook
- **Endpoint Debug**: `/prep_management/telegram/debug/`
- **ðŸ†• API Debug**: `/prep_management/api-debug/`
- **ðŸ†• Merchants List**: `/prep_management/merchants/`
- **ðŸ†• Webhook Dashboard**: `/prep_management/shipment-updates/`
- **ðŸ†• Webhook Endpoint**: `/prep_management/webhook/shipment-status/`
- **Logging avanzato**: Per debugging notifiche e API calls

### Verifica Foto (picture_check)
- Upload e verifica foto prodotti
- Matching EAN con database
- API REST per frontend React
- Gestione clienti e prodotti

### Gestione Resi (return_management)
- Processamento resi Amazon
- Tracking stato resi
- Integrazione con sistemi esterni

### Gestione File (fbasaving)
- Upload e backup documenti
- Processamento automatico file
- Email notification backup
- Gestione storage file

### Etichettatura Pallet (pallet_label)
- **Creazione etichette**: Form completo e rapido
- **Gestione dati**: Mittente, destinatario, warehouse Amazon
- **Generazione PDF**: Layout professionale con ReportLab
- **CRUD completo**: Lista, creazione, modifica, dettaglio
- **Download PDF**: Etichette scaricabili direttamente
- **Ricerca e filtri**: Lista paginata con funzionalitÃ  di ricerca
- **Validazione**: Form validation completa
- **Admin integration**: Gestione via Django admin

### ðŸ†• **Sistema API Prep Business**
- **Client HTTP**: Gestione chiamate API centralizzate
- **Merchants Management**: Lista e dettagli merchants
- **Shipments Management**: CRUD operations
- **Error Handling**: Gestione errori standardizzata
- **Configuration**: Gestione configurazioni via database
- **Logging**: Logging dettagliato per debugging

### ðŸ†• **Sistema Webhook**
- **Real-time Notifications**: Ricezione eventi da Prep Business
- **Event Processing**: Gestione diversi tipi di evento
- **Signature Verification**: Verifica autenticitÃ  webhook
- **Dashboard**: Interfaccia per monitoraggio eventi
- **Raw Payload Viewing**: Debug con visualizzazione JSON
- **Filtering**: Filtri per tipo evento e stato

## ðŸŒ Internazionalizzazione

### Sistema Traduzioni
- **Lingue**: Italiano (default), Inglese
- **Implementazione**: Dizionario centralizzato in `translations.py`
- **Scope**: Bot Telegram, messaggi sistema
- **Fallback**: Automatico su italiano se traduzione mancante

### Configurazione i18n Django
```python
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'Europe/Rome'  # IMPORTANTE: Timezone italiana
USE_I18N = True
USE_TZ = True
LANGUAGES = [('it', 'Italiano'), ('en', 'English')]
```

## ðŸ”„ Workflow di Sviluppo

### ðŸš€ **AMBIENTE PRINCIPALE: Railway (PRODUZIONE)**
- **Backend ATTIVO**: `https://backend.fbaprepcenteritaly.com` - **DOMINIO UNIFICATO**
- **Frontend ATTIVO**: `https://apppc.fbaprepcenteritaly.com` - **CompatibilitÃ **
- **Database**: PostgreSQL (Railway)
- **Bot Telegram**: âœ… ATTIVO e operativo
- **ðŸ†• API Prep Business**: âœ… INTEGRATA e funzionante
- **ðŸ†• Webhook System**: âœ… ATTIVO per notifiche real-time

### ðŸ’» **Ambiente Locale (Solo sviluppo/testing)**

1. **Sviluppo Locale**:
   - Backend: `cd backend && python manage.py runserver`
   - Frontend: `cd frontend_picture_check && npm start`
   - Database: SQLite locale

2. **Testing Locale**:
   - Test units in ogni app Django
   - Test bot Telegram con script dedicati
   - Test traduzioni automatizzati
   - Test notifiche con endpoint debug
   - **Test PDF generation**: Verifica generazione etichette
   - **ðŸ†• Test API Prep Business**: Verifica client API
   - **ðŸ†• Test Webhook**: Simulazione eventi webhook

3. **Deployment su Railway**:
   - Push su repository â†’ **Deploy automatico Railway**
   - Build frontend integrato nel backend
   - Migrazioni database automatiche su PostgreSQL
   - Collectstatic automatico per produzione

## ðŸ“ˆ Monitoraggio e Logging

### Logging
- **Directory**: `/tmp/logs/` (temporanei)
- **Livelli**: Configurati per debug/info/error
- **Filtri**: Custom filters in `logging_filters.py`
- **Telegram**: Logging dettagliato per notifiche
- **PDF Generation**: Logging per debug generazione etichette
- **ðŸ†• API Calls**: Logging per chiamate Prep Business API
- **ðŸ†• Webhook Events**: Logging per eventi webhook ricevuti

### Celery Monitoring
- Worker status tramite comandi Celery
- Task monitoring integrato

## ðŸ” Configurazione Sicurezza

### Produzione
```python
DEBUG = False
ALLOWED_HOSTS = ['prepcenter-production.up.railway.app', 'backend.fbaprepcenteritaly.com', 'apppc.fbaprepcenteritaly.com']
CSRF_TRUSTED_ORIGINS = ['https://prepcenter-production.up.railway.app', 'https://backend.fbaprepcenteritaly.com']
SECRET_KEY = 'django-insecure-...' # Da cambiare in produzione
```

### CORS
- Configurato per domini specifici
- Headers permessi per API calls
- Credentials support per autenticazione

## ðŸ“ Note Importanti per Sviluppo

1. **File manage.py**: Si trova in `/backend/manage.py`, non nella root
2. **Frontend Build**: I file React vengono integrati nel backend Django
3. **Database**: Usare sempre le migrazioni Django
4. **Static Files**: SEMPRE usare `STATIC_ROOT = BASE_DIR / 'static'` su Railway
5. **Traduzioni**: Usare sempre il sistema centralizzato
6. **Tasks**: Preferire Celery per operazioni lunghe
7. **API**: Seguire pattern REST con DRF
8. **Logging**: Configurare sempre logging appropriato
9. **Telegram**: Usare `primaryEmail` non `email` per merchant data
10. **Timezone**: Sempre convertire a `Europe/Rome` per le notifiche
11. **PDF Files**: Salvati in `/media/pallet_labels/` con naming univoco
12. **Dashboard**: Usare `backend.fbaprepcenteritaly.com` come dominio principale
13. **Migrazioni**: Gestire conflitti con merge migrations quando necessario
14. **ðŸ†• Libs Path**: Aggiunto `/backend/libs` al Python path in settings.py
15. **ðŸ†• API Client**: Usare sempre il client centralizzato per Prep Business
16. **ðŸ†• Environment Variables**: Gestire con python-dotenv per sviluppo locale
17. **ðŸ†• Webhook Signatures**: Implementare verifica HMAC quando possibile
18. **ðŸ†• Template Tags**: Caricare custom filters con `{% load prep_management_extras %}`
19. **ðŸ†• JSON Handling**: Usare `json.dumps()` con `indent=2` per pretty printing
20. **ðŸ†• Error Handling**: Implementare sempre try/catch per API calls

## ðŸš¨ Troubleshooting Comuni

### Static Files Issues
1. **Django Admin CSS/JS 404**: 
   - Verificare `STATIC_ROOT = BASE_DIR / 'static'`
   - NON usare `STATICFILES_DIRS` in produzione
   - NON aggiungere URL patterns manuali
   - Eseguire `python manage.py collectstatic`

2. **WhiteNoise non funziona**: 
   - Verificare ordine middleware
   - NON servire static files manualmente

### Telegram Notifications Issues
3. **Notifiche non arrivano**:
   - Verificare eventi in `notify_events` list
   - Controllare campo `primaryEmail` vs `email`
   - Usare endpoint debug: `/prep_management/telegram/debug/`
   - Verificare timezone nelle notifiche

4. **Bot comandi non funzionano**:
   - Verificare tutti i comandi in `telegram_webhook()`
   - Implementare handler per ogni comando promised

### Migration Issues
5. **Conflitti migrazioni**:
   - Creare merge migration: `python manage.py makemigrations --merge`
   - Verificare dipendenze tra app
   - Testare migrazioni in locale prima del deploy

### PDF Generation Issues
6. **PDF non generati**:
   - Verificare installazione ReportLab e Pillow
   - Controllare permessi directory `/media/pallet_labels/`
   - Verificare configurazione MEDIA_URL e MEDIA_ROOT

### Domain Issues
7. **App non accessibili**:
   - Usare `backend.fbaprepcenteritaly.com` per tutte le app
   - `apppc.fbaprepcenteritaly.com` funziona solo per picture_check
   - Verificare configurazione ALLOWED_HOSTS

### ðŸ†• **API Issues**
8. **API Prep Business non risponde**:
   - Verificare URL: `https://dashboard.fbaprepcenteritaly.com/api`
   - Controllare API key in environment variables
   - Usare endpoint debug: `/prep_management/api-debug/`
   - Verificare logs per errori HTTP

9. **Webhook non ricevuti**:
   - Verificare endpoint: `/prep_management/webhook/shipment-status/`
   - Controllare signature verification se abilitata
   - Verificare logs per errori di parsing JSON
   - Testare con payload di esempio

### ðŸ†• **Template Issues**
10. **Template tags non funzionano**:
    - Verificare `{% load prep_management_extras %}` all'inizio del template
    - Controllare che il file `templatetags/__init__.py` esista
    - Riavviare server Django dopo modifiche ai template tags

11. **JSON non visualizzato**:
    - Usare filtro `|pprint` per pretty printing JSON
    - Verificare che il campo sia un dict/list valido
    - Controllare escape HTML per caratteri speciali

### ðŸ†• **Shared Library Issues**
12. **Import errors da libs/**:
    - Verificare che `/backend/libs` sia nel Python path
    - Controllare tutti i file `__init__.py` nelle directory libs
    - Evitare import circolari tra libs e app Django

### General Issues
13. **manage.py not found**: Assicurarsi di essere in `/backend/`
14. **CORS errors**: Verificare configurazione domini
15. **Database errors**: Controllare migrazioni
16. **Frontend non carica**: Controllare build process

## ðŸ”§ Debugging Tools

### Endpoint Disponibili (PRODUZIONE Railway)
- `https://backend.fbaprepcenteritaly.com/` - **Dashboard unificata**
- `https://backend.fbaprepcenteritaly.com/prep_management/telegram/debug/` - Debug notifiche Telegram
- `https://backend.fbaprepcenteritaly.com/prep_management/api-debug/` - **ðŸ†• Debug API Prep Business**
- `https://backend.fbaprepcenteritaly.com/prep_management/merchants/` - **ðŸ†• Lista Merchants**
- `https://backend.fbaprepcenteritaly.com/prep_management/shipment-updates/` - **ðŸ†• Dashboard Webhook**
- `https://backend.fbaprepcenteritaly.com/prep_management/webhook/shipment-status/` - **ðŸ†• Webhook Endpoint**
- `https://backend.fbaprepcenteritaly.com/admin/` - Django Admin (richiede superuser)
- `https://backend.fbaprepcenteritaly.com/api/` - API endpoints principali
- `https://backend.fbaprepcenteritaly.com/pallet_label/` - App etichettatura pallet

### Comandi Utili (Sviluppo Locale)
```bash
# Verifica configurazione (locale)
python manage.py check

# Test connessione database (locale)
python manage.py dbshell

# Verifica migrazioni (locale)
python manage.py showmigrations

# Verifica static files (locale)
python manage.py collectstatic --dry-run

# Test Celery (locale)
celery -A prep_center inspect ping

# Test PDF generation (locale)
python manage.py shell
>>> from pallet_label.services import generate_pallet_label_pdf
>>> # Test PDF generation

# ðŸ†• Test API Prep Business (locale)
python manage.py shell
>>> from libs.prepbusiness.client import PrepBusinessClient
>>> client = PrepBusinessClient()
>>> merchants = client.get_merchants()
>>> print(f"Found {len(merchants)} merchants")

# ðŸ†• Test configurazione API (locale)
python manage.py shell
>>> from libs.config import get_prep_business_config
>>> config = get_prep_business_config()
>>> print(f"API URL: {config['api_url']}")

# ðŸ†• Test webhook processing (locale)
python manage.py shell
>>> from prep_management.models import ShipmentStatusUpdate
>>> updates = ShipmentStatusUpdate.objects.all()
>>> print(f"Total webhook events: {updates.count()}")
```

### ðŸš€ **Monitoraggio Produzione Railway**
- **Railway Dashboard**: Monitoraggio servizi attivi
- **Logs**: Accessibili via Railway CLI o dashboard
- **Database**: Gestito automaticamente da Railway
- **Deploy**: Automatico su push repository
- **Static Files**: Serviti automaticamente da WhiteNoise

## ðŸŽ¯ Prossimi Sviluppi

- Espansione lingue supportate
- Nuove funzionalitÃ  prep management
- Ottimizzazioni performance
- Miglioramenti UI/UX dashboard unificata
- Integrazione nuovi servizi esterni 
- Miglioramenti sistema logging
- Dashboard per monitoraggio notifiche
- **Miglioramenti Pallet Label**:
  - Template PDF personalizzabili
  - Batch generation per piÃ¹ etichette
  - Integrazione con API Amazon
  - QR codes per tracking
  - Export dati in Excel/CSV
- **ðŸ†• Miglioramenti API System**:
  - Cache per chiamate API frequenti
  - Rate limiting per API calls
  - Retry logic piÃ¹ sofisticato
  - Monitoring API performance
- **ðŸ†• Miglioramenti Webhook System**:
  - Batch processing per eventi multipli
  - Retry logic per eventi falliti
  - Dashboard analytics per eventi
  - Alert system per eventi critici
  - Webhook replay functionality 